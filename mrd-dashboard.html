<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRD Data Dashboard - Analytics & Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 215, 0, 0.3);
            padding: 20px 0;
        }
        
        .sidebar h2 {
            color: #FFD700;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin: 5px 0;
        }
        
        .nav-link {
            display: block;
            padding: 15px 25px;
            color: #ccc;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border-left-color: #FFD700;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .header h1 {
            color: #FFD700;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #ccc;
            font-size: 1.1rem;
        }
        
        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            color: #FFD700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .card-subtitle {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        /* Data Tables */
        .data-section {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .section-title {
            color: #FFD700;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table th {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .data-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: #fff;
        }
        
        /* Status Indicators */
        .status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }
        
        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        .status-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }
        
        /* Hidden sections */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                font-size: 0.8rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 5px;
            }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #ccc;
        }

        .analytics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,215,0,0.3);
            text-align: center;
        }

        .analytics-card h3 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .analytics-number {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        /* Report Styling */
        .report-section {
            margin-bottom: 40px;
        }

        .report-section h3 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid rgba(255,215,0,0.3);
            padding-bottom: 10px;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,215,0,0.3);
            text-align: center;
        }

        .report-card h4 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .report-value {
            font-size: 28px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .report-detail {
            font-size: 12px;
            color: #ccc;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-panel {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .analytics-panel h4 {
            color: #FFD700;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .performance-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .performance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            border: 1px solid rgba(255,215,0,0.1);
        }

        .performance-label {
            color: #fff;
            font-size: 14px;
        }

        .performance-value {
            color: #FFD700;
            font-weight: bold;
            font-size: 14px;
        }

        .performance-value .submissions {
            color: #4CAF50;
            margin-right: 10px;
        }

        .performance-value .events {
            color: #2196F3;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .recommendation-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .recommendation-card.priority-high {
            border-color: rgba(244, 67, 54, 0.5);
        }

        .recommendation-card.priority-medium {
            border-color: rgba(255, 152, 0, 0.5);
        }

        .recommendation-card.priority-low {
            border-color: rgba(76, 175, 80, 0.5);
        }

        .recommendation-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-badge.priority-high {
            background: rgba(244, 67, 54, 0.8);
            color: #fff;
        }

        .priority-badge.priority-medium {
            background: rgba(255, 152, 0, 0.8);
            color: #fff;
        }

        .priority-badge.priority-low {
            background: rgba(76, 175, 80, 0.8);
            color: #fff;
        }

        .category-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(255,215,0,0.2);
            color: #FFD700;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .recommendation-card h4 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .recommendation-card p {
            color: #ccc;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .impact-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .impact-label {
            color: #ccc;
            font-size: 12px;
        }

        .impact-value {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .impact-value.impact-high {
            background: rgba(244, 67, 54, 0.8);
            color: #fff;
        }

        .impact-value.impact-medium {
            background: rgba(255, 152, 0, 0.8);
            color: #fff;
        }

        .impact-value.impact-low {
            background: rgba(76, 175, 80, 0.8);
            color: #fff;
        }

        /* Page Badge Styling */
        .page-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            background: rgba(255,215,0,0.2);
            color: #FFD700;
            border: 1px solid rgba(255,215,0,0.3);
        }
        
        .empty-state h3 {
            color: #FFD700;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <h2>üìä MRD Dashboard</h2>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        üìà Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="datalog">
                        üìã DataLog
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="analyticslog">
                        üìä AnalyticsLog
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="reports">
                        üìÑ Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="analytics">
                        üîç Analytics
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="header">
                    <h1>üìà MRD Data Dashboard</h1>
                    <p>Comprehensive analytics and data management for your website</p>
                </div>

                <!-- Dashboard Cards -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-title">
                            üìã Total Submissions
                        </div>
                        <div class="card-value" id="total-submissions">0</div>
                        <div class="card-subtitle">Form submissions received</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">
                            üìä Analytics Events
                        </div>
                        <div class="card-value" id="total-analytics">0</div>
                        <div class="card-subtitle">User interactions tracked</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">
                            üéØ Conversion Rate
                        </div>
                        <div class="card-value" id="conversion-rate">0%</div>
                        <div class="card-subtitle">Form completion rate</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">
                            ‚è∞ Last Activity
                        </div>
                        <div class="card-value" id="last-activity">Never</div>
                        <div class="card-subtitle">Most recent submission</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="data-section">
                    <h2 class="section-title">üöÄ Quick Actions</h2>
                    <button class="btn" onclick="testFormSubmission()">Submit Test Form</button>
                    <button class="btn btn-secondary" onclick="generateTestAnalytics()">Generate Test Analytics</button>
                    <button class="btn btn-secondary" onclick="refreshAllData()">Refresh Data</button>
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                    <div id="test-status" class="status status-info" style="margin-top: 15px;">Ready to test</div>
                </div>
            </section>

            <!-- DataLog Section -->
            <section id="datalog" class="section">
                <div class="header">
                    <h1>üìã DataLog - Form Submissions</h1>
                    <p>All form submissions organized by Google Sheet structure</p>
                </div>

                <div class="data-section">
                    <h2 class="section-title">Form Submissions</h2>
                    <button class="btn btn-secondary" onclick="refreshFormData()">Refresh</button>
                    <div id="form-submissions-container">
                        <div class="empty-state">
                            <h3>No form submissions yet</h3>
                            <p>Submit a form to see data here</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AnalyticsLog Section -->
            <section id="analyticslog" class="section">
                <div class="header">
                    <h1>üìä AnalyticsLog - User Interactions</h1>
                    <p>Detailed analytics and user behavior tracking</p>
                </div>

                <div class="data-section">
                    <h2 class="section-title">Analytics Events</h2>
                    <button class="btn btn-secondary" onclick="refreshAnalyticsData()">Refresh</button>
                    <div id="analytics-container">
                        <div class="empty-state">
                            <h3>No analytics data yet</h3>
                            <p>User interactions will appear here</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="section">
                <div class="header">
                    <h1>üìÑ Reports - Data Analysis</h1>
                    <p>Comprehensive reports and insights</p>
                </div>

                <div class="data-section">
                    <h2 class="section-title">üìà Performance Report</h2>
                    <div id="reports-container">
                        <div class="empty-state">
                            <h3>Generating reports...</h3>
                            <p>Click refresh to generate performance reports</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="section">
                <div class="header">
                    <h1>üîç Analytics - Deep Dive</h1>
                    <p>Advanced analytics and data visualization</p>
                </div>

                <div class="data-section">
                    <h2 class="section-title">üìä Data Overview</h2>
                    <div id="analytics-overview">
                        <div class="empty-state">
                            <h3>Loading analytics...</h3>
                            <p>Analytics data will be displayed here</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MRD Brain System -->
    <script src="mrd-brain-system.js"></script>
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Global variables
        let currentSection = 'dashboard';
        let formSubmissions = [];
        let analyticsData = {};

        // Initialize MRD Brain System and Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof MRDBrainSystem !== 'undefined') {
                window.MRDBrain = new MRDBrainSystem();
                console.log('‚úÖ MRD Brain System initialized');
            } else {
                console.error('‚ùå MRD Brain System not loaded');
            }
            
            // Initialize dashboard
            initializeDashboard();
            setupNavigation();
            loadAllData();

            // Live updates across tabs/windows on the same origin
            window.addEventListener('storage', function(event) {
                if (!event.key || !event.key.startsWith('mrd_brain_')) return;
                loadAllData();
                if (currentSection === 'datalog') displayFormSubmissions();
                if (currentSection === 'analyticslog') displayAnalyticsData();
                if (currentSection === 'reports') generateReports();
                if (currentSection === 'analytics') loadAnalyticsOverview();
            });
        });

        // Navigation functionality
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked nav link
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            
            currentSection = sectionId;
            
            // Load section-specific data
            switch(sectionId) {
                case 'datalog':
                    loadFormSubmissions();
                    break;
                case 'analyticslog':
                    loadAnalyticsData();
                    break;
                case 'reports':
                    generateReports();
                    break;
                case 'analytics':
                    loadAnalyticsOverview();
                    break;
            }
        }

        // Data loading functions
        function loadAllData() {
            loadFormSubmissions();
            loadAnalyticsData();
            updateDashboard();
            updateAnalyticsOverview();
        }

        function loadFormSubmissions() {
            try {
                formSubmissions = JSON.parse(localStorage.getItem('mrd_brain_form_submissions') || '[]');
                displayFormSubmissions();
            } catch (error) {
                console.error('Error loading form submissions:', error);
            }
        }

        function loadAnalyticsData() {
            try {
                // Try multiple analytics storage keys
                let rawData = localStorage.getItem('mrd_brain_analytics');
                
                if (!rawData) {
                    // Try alternative keys
                    rawData = localStorage.getItem('mrd_brain_analytics_events');
                    if (rawData) {
                        // Convert events array to session structure
                        const events = JSON.parse(rawData);
                        analyticsData = { 'default_session': { events: events } };
                    } else {
                        // Try other possible keys
                        rawData = localStorage.getItem('mrd_brain_analytics_data');
                        if (rawData) {
                            analyticsData = JSON.parse(rawData);
                        } else {
                            analyticsData = {};
                        }
                    }
                } else {
                    analyticsData = JSON.parse(rawData);
                }
                
                // Ensure we have the right structure
                if (typeof analyticsData === 'object' && !Array.isArray(analyticsData)) {
                    // Check if it's a flat object with events
                    if (analyticsData.events && Array.isArray(analyticsData.events)) {
                        analyticsData = { 'default_session': { events: analyticsData.events } };
                    }
                }
                
                console.log(`üìä Loaded analytics data for ${Object.keys(analyticsData).length} sessions`);
                console.log('Analytics data structure:', analyticsData);
                
                // Update analytics overview
                updateAnalyticsOverview();
                displayAnalyticsData();
            } catch (error) {
                console.error('Error loading analytics data:', error);
                analyticsData = {};
            }
        }

        // Display functions
        function displayFormSubmissions() {
            const container = document.getElementById('form-submissions-container');
            
            if (formSubmissions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No form submissions yet</h3>
                        <p>Submit a form to see data here</p>
                    </div>
                `;
                return;
            }

            // Normalize all submissions (support nested data and flat shape)
            const normalized = formSubmissions.map(s => normalizeSubmission(s));

            // Create table matching Google Sheet structure
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Page Source</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Course Interest</th>
                            <th>Message</th>
                            <th>Form ID</th>
                            <th>Session ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${normalized.map(submission => `
                            <tr>
                                <td>${formatTimestamp(submission.timestamp)}</td>
                                <td>${formatPage(submission.page_source)}</td>
                                <td>${submission.name || 'N/A'}</td>
                                <td>${submission.email || 'N/A'}</td>
                                <td>${submission.phone || 'N/A'}</td>
                                <td>${submission.course_interest || submission.service_interest || 'N/A'}</td>
                                <td>${truncateText(submission.message || 'N/A', 50)}</td>
                                <td>${submission.form_id || 'N/A'}</td>
                                <td>${submission.session_id || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;

            // Update charts when submissions render
            updateCharts(normalized);
        }

        function displayAnalyticsData() {
            const container = document.getElementById('analytics-container');
            
            if (Object.keys(analyticsData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No analytics data yet</h3>
                        <p>User interactions will appear here</p>
                        <button class="btn btn-primary" onclick="generateTestAnalytics()">Generate Test Analytics</button>
                    </div>
                `;
                return;
            }

            // Create analytics table with enhanced data extraction
            const events = [];
            Object.keys(analyticsData).forEach(sessionId => {
                const session = analyticsData[sessionId];
                if (session.events && Array.isArray(session.events)) {
                    session.events.forEach(event => {
                        // Enhanced page detection
                        let pageName = 'unknown_page';
                        if (event.page) {
                            pageName = event.page;
                        } else if (event.data && event.data.url) {
                            // Extract page from URL
                            const url = event.data.url;
                            if (url.includes('index.html') || url.includes('/')) pageName = 'home_page';
                            else if (url.includes('courses')) pageName = 'courses_page';
                            else if (url.includes('learn')) pageName = 'learn_page';
                            else if (url.includes('contact')) pageName = 'contact_page';
                            else if (url.includes('join')) pageName = 'join_page';
                            else if (url.includes('cryptocurrency')) pageName = 'cryptocurrency_page';
                        } else if (event.data && event.data.page) {
                            pageName = event.data.page;
                        }

                        events.push({
                            timestamp: event.timestamp,
                            event_type: event.type || 'unknown',
                            session_id: sessionId,
                            page: pageName,
                            user_agent: event.data?.user_agent || event.user_agent || 'N/A',
                            screen_size: event.data?.screen_size || event.screen_size || 'N/A',
                            referrer: event.data?.referrer || event.referrer || 'N/A',
                            data: event.data || {}
                        });
                    });
                }
            });

            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No analytics events yet</h3>
                        <p>User interactions will appear here</p>
                        <button class="btn btn-primary" onclick="generateTestAnalytics()">Generate Test Analytics</button>
                    </div>
                `;
                return;
            }

            // Sort events by timestamp (newest first)
            events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Event Type</th>
                            <th>Session ID</th>
                            <th>Page</th>
                            <th>User Agent</th>
                            <th>Screen Size</th>
                            <th>Referrer</th>
                            <th>Event Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${events.map(event => `
                            <tr>
                                <td>${formatTimestamp(event.timestamp)}</td>
                                <td><span class="status status-info">${event.event_type}</span></td>
                                <td>${truncateText(event.session_id, 15)}</td>
                                <td><span class="page-badge">${formatPage(event.page)}</span></td>
                                <td>${truncateText(event.user_agent, 20)}</td>
                                <td>${event.screen_size}</td>
                                <td>${truncateText(event.referrer, 15)}</td>
                                <td>${truncateText(JSON.stringify(event.data), 30)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        function updateDashboard() {
            // Update dashboard cards
            document.getElementById('total-submissions').textContent = formSubmissions.length;
            
            const totalEvents = Object.keys(analyticsData).reduce((total, sessionId) => {
                const session = analyticsData[sessionId];
                return total + (session.events ? session.events.length : 0);
            }, 0);
            document.getElementById('total-analytics').textContent = totalEvents;
            
            // Calculate conversion rate (simplified)
            const conversionRate = formSubmissions.length > 0 ? 
                Math.round((formSubmissions.length / Math.max(totalEvents, 1)) * 100) : 0;
            document.getElementById('conversion-rate').textContent = conversionRate + '%';
            
            // Last activity
            if (formSubmissions.length > 0) {
                const lastSubmission = normalizeSubmission(formSubmissions[formSubmissions.length - 1]);
                document.getElementById('last-activity').textContent = formatTimestamp(lastSubmission.timestamp);
            }
        }

        function updateAnalyticsOverview() {
            const container = document.getElementById('analytics-overview');
            
            if (Object.keys(analyticsData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No analytics data yet</h3>
                        <p>User interactions will appear here</p>
                        <button class="btn btn-primary" onclick="generateTestAnalytics()">Generate Test Analytics</button>
                    </div>
                `;
                return;
            }

            const totalEvents = getTotalAnalyticsEvents();
            const uniqueSessions = Object.keys(analyticsData).length;
            const topPages = getTopAnalyticsPages();
            
            container.innerHTML = `
                <div class="analytics-cards">
                    <div class="analytics-card">
                        <h3>Total Events</h3>
                        <div class="analytics-number">${totalEvents}</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Unique Sessions</h3>
                        <div class="analytics-number">${uniqueSessions}</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Top Page</h3>
                        <div class="analytics-number">${topPages}</div>
                    </div>
                </div>
            `;
        }

        function getTotalAnalyticsEvents() {
            let total = 0;
            Object.keys(analyticsData).forEach(sessionId => {
                const session = analyticsData[sessionId];
                if (session.events && Array.isArray(session.events)) {
                    total += session.events.length;
                }
            });
            return total;
        }

        function getTopAnalyticsPages() {
            const pageCounts = {};
            Object.keys(analyticsData).forEach(sessionId => {
                const session = analyticsData[sessionId];
                if (session.events && Array.isArray(session.events)) {
                    session.events.forEach(event => {
                        const page = event.page || 'unknown';
                        pageCounts[page] = (pageCounts[page] || 0) + 1;
                    });
                }
            });
            
            const sortedPages = Object.entries(pageCounts)
                .sort(([,a], [,b]) => b - a);
            
            return sortedPages.length > 0 ? formatPage(sortedPages[0][0]) : 'N/A';
        }

        function generateReports() {
            const container = document.getElementById('reports-container');
            
            // Calculate detailed performance metrics
            const metrics = calculatePerformanceMetrics();
            
            const reports = `
                <div class="report-section">
                    <h3>üìä Performance Summary</h3>
                    <div class="report-grid">
                        <div class="report-card">
                            <h4>Form Conversion Rate</h4>
                            <div class="report-value">${metrics.conversionRate}%</div>
                            <div class="report-detail">${metrics.totalSubmissions} submissions from ${metrics.totalSessions} sessions</div>
                        </div>
                        <div class="report-card">
                            <h4>Average Session Time</h4>
                            <div class="report-value">${metrics.avgSessionTime}</div>
                            <div class="report-detail">Based on ${metrics.totalEvents} interactions</div>
                        </div>
                        <div class="report-card">
                            <h4>Top Performing Page</h4>
                            <div class="report-value">${metrics.topPage}</div>
                            <div class="report-detail">${metrics.topPageSubmissions} submissions</div>
                        </div>
                        <div class="report-card">
                            <h4>Storage Usage</h4>
                            <div class="report-value">${getStorageUsage()}</div>
                            <div class="report-detail">${metrics.totalRecords} total records</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>üìà Detailed Analytics</h3>
                    <div class="analytics-grid">
                        <div class="analytics-panel">
                            <h4>Page Performance</h4>
                            ${generatePagePerformanceReport(metrics.pageStats)}
                        </div>
                        <div class="analytics-panel">
                            <h4>Form Performance</h4>
                            ${generateFormPerformanceReport(metrics.formStats)}
                        </div>
                        <div class="analytics-panel">
                            <h4>User Behavior</h4>
                            ${generateUserBehaviorReport(metrics.userStats)}
                        </div>
                        <div class="analytics-panel">
                            <h4>System Health</h4>
                            ${generateSystemHealthReport(metrics.systemStats)}
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>üéØ Improvement Recommendations</h3>
                    ${generateImprovementRecommendations(metrics)}
                </div>
            `;
            
            container.innerHTML = reports;
        }

        function loadAnalyticsOverview() {
            const container = document.getElementById('analytics-overview');
            
            const overview = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-title">üìà Data Summary</div>
                        <div class="card-value">${formSubmissions.length + Object.keys(analyticsData).length}</div>
                        <div class="card-subtitle">Total data points</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">üîÑ System Status</div>
                        <div class="card-value">‚úÖ Active</div>
                        <div class="card-subtitle">MRD Brain System</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">üíæ Storage Used</div>
                        <div class="card-value">${getStorageUsage()}</div>
                        <div class="card-subtitle">LocalStorage usage</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-title">üïí Last Update</div>
                        <div class="card-value">${new Date().toLocaleTimeString()}</div>
                        <div class="card-subtitle">Data refresh time</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = overview;
        }

        function calculatePerformanceMetrics() {
            const totalSubmissions = formSubmissions.length;
            const totalSessions = Object.keys(analyticsData).length;
            const totalEvents = getTotalAnalyticsEvents();
            
            // Calculate conversion rate
            const conversionRate = totalSessions > 0 ? Math.round((totalSubmissions / totalSessions) * 100) : 0;
            
            // Calculate page statistics
            const pageStats = {};
            const formStats = {};
            const userStats = {
                totalSessions: totalSessions,
                avgEventsPerSession: totalSessions > 0 ? Math.round(totalEvents / totalSessions) : 0,
                bounceRate: 0
            };
            
            // Analyze form submissions by page
            formSubmissions.forEach(submission => {
                const normalized = normalizeSubmission(submission);
                const page = normalized.page_source || 'unknown';
                pageStats[page] = pageStats[page] || { submissions: 0, forms: new Set() };
                pageStats[page].submissions++;
                pageStats[page].forms.add(normalized.form_id || 'unknown');
            });
            
            // Analyze analytics events
            Object.keys(analyticsData).forEach(sessionId => {
                const session = analyticsData[sessionId];
                if (session.events && Array.isArray(session.events)) {
                    session.events.forEach(event => {
                        const page = event.page || 'unknown';
                        pageStats[page] = pageStats[page] || { submissions: 0, forms: new Set(), events: 0 };
                        pageStats[page].events = (pageStats[page].events || 0) + 1;
                    });
                }
            });
            
            // Find top page
            let topPage = 'N/A';
            let topPageSubmissions = 0;
            Object.entries(pageStats).forEach(([page, stats]) => {
                if (stats.submissions > topPageSubmissions) {
                    topPageSubmissions = stats.submissions;
                    topPage = formatPage(page);
                }
            });
            
            // Calculate average session time (simplified)
            const avgSessionTime = totalEvents > 0 ? Math.round((totalEvents * 2.5) / 60 * 10) / 10 + 'm' : '0m';
            
            // System health metrics
            const systemStats = {
                dataIntegrity: totalSubmissions > 0 ? 'Good' : 'No Data',
                storageEfficiency: getStorageUsage(),
                errorRate: 0,
                uptime: '100%'
            };
            
            return {
                totalSubmissions,
                totalSessions,
                totalEvents,
                conversionRate,
                avgSessionTime,
                topPage,
                topPageSubmissions,
                pageStats,
                formStats,
                userStats,
                systemStats,
                totalRecords: totalSubmissions + totalEvents
            };
        }

        function generatePagePerformanceReport(pageStats) {
            const sortedPages = Object.entries(pageStats)
                .sort(([,a], [,b]) => (b.submissions || 0) - (a.submissions || 0))
                .slice(0, 5);
            
            return `
                <div class="performance-list">
                    ${sortedPages.map(([page, stats]) => `
                        <div class="performance-item">
                            <div class="performance-label">${formatPage(page)}</div>
                            <div class="performance-value">
                                <span class="submissions">${stats.submissions || 0} submissions</span>
                                <span class="events">${stats.events || 0} events</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateFormPerformanceReport(formStats) {
            const formTypes = {};
            formSubmissions.forEach(submission => {
                const normalized = normalizeSubmission(submission);
                const formType = normalized.form_id || 'unknown';
                formTypes[formType] = (formTypes[formType] || 0) + 1;
            });
            
            const sortedForms = Object.entries(formTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            return `
                <div class="performance-list">
                    ${sortedForms.map(([form, count]) => `
                        <div class="performance-item">
                            <div class="performance-label">${form}</div>
                            <div class="performance-value">${count} submissions</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateUserBehaviorReport(userStats) {
            return `
                <div class="performance-list">
                    <div class="performance-item">
                        <div class="performance-label">Total Sessions</div>
                        <div class="performance-value">${userStats.totalSessions}</div>
                    </div>
                    <div class="performance-item">
                        <div class="performance-label">Avg Events/Session</div>
                        <div class="performance-value">${userStats.avgEventsPerSession}</div>
                    </div>
                    <div class="performance-item">
                        <div class="performance-label">Engagement Level</div>
                        <div class="performance-value">${userStats.avgEventsPerSession > 5 ? 'High' : userStats.avgEventsPerSession > 2 ? 'Medium' : 'Low'}</div>
                    </div>
                </div>
            `;
        }

        function generateSystemHealthReport(systemStats) {
            return `
                <div class="performance-list">
                    <div class="performance-item">
                        <div class="performance-label">Data Integrity</div>
                        <div class="performance-value status-${systemStats.dataIntegrity === 'Good' ? 'success' : 'warning'}">${systemStats.dataIntegrity}</div>
                    </div>
                    <div class="performance-item">
                        <div class="performance-label">Storage Usage</div>
                        <div class="performance-value">${systemStats.storageEfficiency}</div>
                    </div>
                    <div class="performance-item">
                        <div class="performance-label">System Status</div>
                        <div class="performance-value status-success">Operational</div>
                    </div>
                </div>
            `;
        }

        function generateImprovementRecommendations(metrics) {
            const recommendations = [];
            
            if (metrics.conversionRate < 10) {
                recommendations.push({
                    priority: 'High',
                    category: 'Conversion',
                    title: 'Improve Form Conversion Rate',
                    description: `Current rate is ${metrics.conversionRate}%. Consider optimizing form design, reducing fields, or adding trust signals.`,
                    impact: 'High'
                });
            }
            
            if (metrics.topPageSubmissions < 5) {
                recommendations.push({
                    priority: 'Medium',
                    category: 'Content',
                    title: 'Boost Page Engagement',
                    description: `Top page has only ${metrics.topPageSubmissions} submissions. Consider improving content, CTAs, or user experience.`,
                    impact: 'Medium'
                });
            }
            
            if (metrics.userStats.avgEventsPerSession < 3) {
                recommendations.push({
                    priority: 'Medium',
                    category: 'Engagement',
                    title: 'Increase User Engagement',
                    description: `Average ${metrics.userStats.avgEventsPerSession} events per session. Consider adding interactive elements or improving navigation.`,
                    impact: 'Medium'
                });
            }
            
            if (metrics.totalSubmissions < 10) {
                recommendations.push({
                    priority: 'High',
                    category: 'Data Collection',
                    title: 'Increase Data Collection',
                    description: `Only ${metrics.totalSubmissions} total submissions. Consider A/B testing forms, improving visibility, or adding more touchpoints.`,
                    impact: 'High'
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    priority: 'Low',
                    category: 'Maintenance',
                    title: 'System Performing Well',
                    description: 'Your system is performing well! Continue monitoring and consider advanced features.',
                    impact: 'Low'
                });
            }
            
            return `
                <div class="recommendations-grid">
                    ${recommendations.map(rec => `
                        <div class="recommendation-card priority-${rec.priority.toLowerCase()}">
                            <div class="recommendation-header">
                                <span class="priority-badge priority-${rec.priority.toLowerCase()}">${rec.priority}</span>
                                <span class="category-badge">${rec.category}</span>
                            </div>
                            <h4>${rec.title}</h4>
                            <p>${rec.description}</p>
                            <div class="impact-indicator">
                                <span class="impact-label">Impact:</span>
                                <span class="impact-value impact-${rec.impact.toLowerCase()}">${rec.impact}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Utility functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                return new Date(timestamp).toLocaleString();
            } catch (e) {
                return timestamp;
            }
        }

        function truncateText(text, maxLength) {
            if (!text) return 'N/A';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function formatPage(page) {
            const map = {
                'home_page': 'Home',
                'courses_page': 'Courses',
                'learn_page': 'Learn',
                'learning_page': 'Learn',
                'contact_page': 'Contact',
                'join_page': 'Join',
                'cryptocurrency_page': 'Cryptocurrency',
                'unknown_page': 'Other'
            };
            return map[page] || page || 'Other';
        }

        function normalizeSubmission(s) {
            // Handles both flat and nested { data: {..} } shapes
            const d = s && s.data ? s.data : s || {};
            return {
                timestamp: s.timestamp || d.timestamp || null,
                page_source: s.page_source || d.page_source || null,
                form_id: s.form_id || d.form_id || null,
                session_id: s.session_id || d.session_id || null,
                name: d.name || d.full_name || d.firstname || d['Full Name'] || null,
                email: d.email || d['Email'] || null,
                phone: d.phone || d['Phone'] || d['Phone Number'] || null,
                course_interest: d.course_interest || d.platform || d['Platform/Course'] || null,
                service_interest: d.service_interest || null,
                message: d.message || d['Message'] || null
            };
        }

        function getTopPages() {
            const pageCounts = {};
            formSubmissions.forEach(submission => {
                const page = submission.page_source || 'Unknown';
                pageCounts[page] = (pageCounts[page] || 0) + 1;
            });
            
            const sortedPages = Object.entries(pageCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            return sortedPages.length > 0 ? sortedPages[0][0] : 'N/A';
        }

        function getAverageSessionTime() {
            // Simplified calculation
            return '2.5m';
        }

        function getStorageUsage() {
            let totalSize = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('mrd_brain_')) {
                    totalSize += localStorage.getItem(key).length;
                }
            }
            return Math.round(totalSize / 1024) + 'KB';
        }

        // Action functions
        function refreshAllData() {
            loadAllData();
            showNotification('Data refreshed successfully!', 'success');
        }

        function refreshFormData() {
            loadFormSubmissions();
            showNotification('Form data refreshed!', 'success');
        }

        function refreshAnalyticsData() {
            loadAnalyticsData();
            showNotification('Analytics data refreshed!', 'success');
        }

        function exportData() {
            const data = {
                formSubmissions: formSubmissions,
                analyticsData: analyticsData,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mrd-data-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all MRD Brain data? This action cannot be undone.')) {
                try {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('mrd_brain_')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    showNotification(`Cleared ${keysToRemove.length} data entries`, 'success');
                    loadAllData();
                } catch (error) {
                    showNotification('Error clearing data: ' + error.message, 'error');
                }
            }
        }

        async function testFormSubmission() {
            const status = document.getElementById('test-status');
            
            if (window.MRDBrain && typeof window.MRDBrain.saveFormSubmission === 'function') {
                try {
                    await window.MRDBrain.saveFormSubmission({
                        email: "test@example.com",
                        name: "Test User",
                        phone: "123-456-7890",
                        message: "Test submission from dashboard",
                        form_id: "test_form",
                        page_source: "dashboard"
                    });
                    
                    status.innerHTML = '‚úÖ Test form submitted successfully!';
                    status.className = 'status status-success';
                    loadAllData();
                } catch (error) {
                    status.innerHTML = '‚ùå Test form submission failed: ' + error.message;
                    status.className = 'status status-warning';
                }
            } else {
                status.innerHTML = '‚ùå MRD Brain system not available';
                status.className = 'status status-warning';
            }
        }

        function generateTestAnalytics() {
            const status = document.getElementById('test-status');
            
            try {
                // Generate comprehensive sample analytics events
                const testEvents = [
                    // Home page events
                    {
                        type: 'page_view',
                        timestamp: new Date(Date.now() - 7200000).toISOString(),
                        page: 'home_page',
                        data: { 
                            url: '/index.html',
                            user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                            screen_size: '1920x1080',
                            referrer: 'https://google.com'
                        }
                    },
                    {
                        type: 'scroll',
                        timestamp: new Date(Date.now() - 7000000).toISOString(),
                        page: 'home_page',
                        data: { scrollPercentage: 50, element: 'main-content' }
                    },
                    {
                        type: 'click',
                        timestamp: new Date(Date.now() - 6800000).toISOString(),
                        page: 'home_page',
                        data: { element: 'join-button', action: 'click' }
                    },
                    
                    // Courses page events
                    {
                        type: 'page_view',
                        timestamp: new Date(Date.now() - 3600000).toISOString(),
                        page: 'courses_page',
                        data: { 
                            url: '/courses.html',
                            user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                            screen_size: '1920x1080',
                            referrer: '/index.html'
                        }
                    },
                    {
                        type: 'scroll',
                        timestamp: new Date(Date.now() - 3400000).toISOString(),
                        page: 'courses_page',
                        data: { scrollPercentage: 75, element: 'course-list' }
                    },
                    {
                        type: 'form_submission',
                        timestamp: new Date(Date.now() - 3200000).toISOString(),
                        page: 'courses_page',
                        data: { 
                            form_id: 'course-interest-form',
                            fields: ['name', 'email', 'course_interest']
                        }
                    },
                    
                    // Contact page events
                    {
                        type: 'page_view',
                        timestamp: new Date(Date.now() - 1800000).toISOString(),
                        page: 'contact_page',
                        data: { 
                            url: '/contact.html',
                            user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                            screen_size: '1920x1080',
                            referrer: '/courses.html'
                        }
                    },
                    {
                        type: 'form_submission',
                        timestamp: new Date(Date.now() - 1600000).toISOString(),
                        page: 'contact_page',
                        data: { 
                            form_id: 'contact-form',
                            fields: ['name', 'email', 'phone', 'message']
                        }
                    },
                    
                    // Join page events
                    {
                        type: 'page_view',
                        timestamp: new Date(Date.now() - 900000).toISOString(),
                        page: 'join_page',
                        data: { 
                            url: '/join.html',
                            user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                            screen_size: '1920x1080',
                            referrer: '/contact.html'
                        }
                    },
                    {
                        type: 'form_submission',
                        timestamp: new Date(Date.now() - 700000).toISOString(),
                        page: 'join_page',
                        data: { 
                            form_id: 'join-form',
                            fields: ['email']
                        }
                    },
                    
                    // Learn page events
                    {
                        type: 'page_view',
                        timestamp: new Date(Date.now() - 300000).toISOString(),
                        page: 'learn_page',
                        data: { 
                            url: '/learn.html',
                            user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                            screen_size: '1920x1080',
                            referrer: '/join.html'
                        }
                    },
                    {
                        type: 'interaction',
                        timestamp: new Date(Date.now() - 100000).toISOString(),
                        page: 'learn_page',
                        data: { 
                            element: 'video-player',
                            action: 'play',
                            duration: 30
                        }
                    }
                ];
                
                // Create multiple sessions with realistic data
                const testAnalytics = {
                    'session_user_1': {
                        events: testEvents.slice(0, 4)
                    },
                    'session_user_2': {
                        events: testEvents.slice(4, 7)
                    },
                    'session_user_3': {
                        events: testEvents.slice(7, 9)
                    },
                    'session_user_4': {
                        events: testEvents.slice(9, 11)
                    },
                    'session_user_5': {
                        events: testEvents.slice(11)
                    }
                };
                
                localStorage.setItem('mrd_brain_analytics', JSON.stringify(testAnalytics));
                
                // Reload analytics data and update displays
                loadAnalyticsData();
                updateDashboard();
                
                status.innerHTML = '‚úÖ Test analytics generated successfully! 5 sessions with 12 events created.';
                status.className = 'status status-success';
                
            } catch (error) {
                status.innerHTML = '‚ùå Failed to generate test analytics: ' + error.message;
                status.className = 'status status-warning';
            }
        }

        function showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `status status-${type}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.padding = '15px 20px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.3)';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function initializeDashboard() {
            // Set up auto-refresh every 30 seconds
            setInterval(() => {
                if (currentSection === 'dashboard') {
                    loadAllData();
                }
            }, 30000);
        }

        // Charts
        let chartByPage = null;
        let chartOverTime = null;

        function ensureCharts() {
            // Inject canvases once into dashboard if not present
            const dashboard = document.getElementById('dashboard');
            if (!document.getElementById('chart-area')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'data-section';
                wrapper.id = 'chart-area';
                wrapper.innerHTML = `
                    <h2 class="section-title">üìä Analytics Dashboard</h2>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;max-width:1000px;margin-left:auto;margin-right:auto;">
                        <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;border:1px solid rgba(255,215,0,0.3);">
                            <h3 style="color:#FFD700;margin-bottom:10px;text-align:center;font-size:14px;">Submissions by Page</h3>
                            <canvas id="chartByPage"></canvas>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;border:1px solid rgba(255,215,0,0.3);">
                            <h3 style="color:#FFD700;margin-bottom:10px;text-align:center;font-size:14px;">Submissions Over Time</h3>
                            <canvas id="chartOverTime"></canvas>
                        </div>
                    </div>
                `;
                dashboard.appendChild(wrapper);
            }
        }

        function updateCharts(normalized) {
            ensureCharts();
            const ctxPage = document.getElementById('chartByPage').getContext('2d');
            const ctxTime = document.getElementById('chartOverTime').getContext('2d');

            // Aggregate by page
            const pageCounts = {};
            normalized.forEach(s => {
                const label = formatPage(s.page_source);
                pageCounts[label] = (pageCounts[label] || 0) + 1;
            });
            const pageLabels = Object.keys(pageCounts);
            const pageValues = pageLabels.map(l => pageCounts[l]);

            // Create doughnut chart for page submissions
            if (chartByPage) chartByPage.destroy();
            chartByPage = new Chart(ctxPage, {
                type: 'doughnut',
                data: {
                    labels: pageLabels,
                    datasets: [{
                        data: pageValues,
                        backgroundColor: [
                            'rgba(255,215,0,0.8)',
                            'rgba(255,165,0,0.8)',
                            'rgba(255,140,0,0.8)',
                            'rgba(255,69,0,0.8)',
                            'rgba(255,20,147,0.8)',
                            'rgba(138,43,226,0.8)'
                        ],
                        borderColor: [
                            'rgba(255,215,0,1)',
                            'rgba(255,165,0,1)',
                            'rgba(255,140,0,1)',
                            'rgba(255,69,0,1)',
                            'rgba(255,20,147,1)',
                            'rgba(138,43,226,1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    aspectRatio: 1.2,
                    animation: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { 
                                color: '#fff',
                                font: { size: 10 },
                                padding: 8
                            } 
                        }
                    }
                }
            });

            // Aggregate over time (last 7 days for simplicity)
            const timeBuckets = {};
            const now = new Date();
            const last7Days = [];
            
            // Create last 7 days array
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
                timeBuckets[dateStr] = 0;
            }
            
            // Count submissions for each day
            normalized.forEach(s => {
                if (s.timestamp) {
                    const date = new Date(s.timestamp);
                    const dateStr = date.toISOString().split('T')[0];
                    if (timeBuckets.hasOwnProperty(dateStr)) {
                        timeBuckets[dateStr]++;
                    }
                }
            });

            const timeLabels = last7Days.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const timeValues = last7Days.map(d => timeBuckets[d]);

            // Create simple bar chart for time
            if (chartOverTime) chartOverTime.destroy();
            chartOverTime = new Chart(ctxTime, {
                type: 'bar',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Submissions',
                        data: timeValues,
                        backgroundColor: 'rgba(255,215,0,0.6)',
                        borderColor: 'rgba(255,215,0,1)',
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    aspectRatio: 1.2,
                    animation: false,
                    plugins: { 
                        legend: { 
                            display: false
                        }
                    },
                    scales: { 
                        x: { 
                            ticks: { 
                                color: '#fff',
                                font: { size: 10 }
                            },
                            grid: { display: false }
                        }, 
                        y: { 
                            ticks: { 
                                color: '#fff',
                                font: { size: 10 },
                                stepSize: 1
                            }, 
                            beginAtZero: true,
                            grid: { 
                                color: 'rgba(255,255,255,0.1)',
                                drawBorder: false
                            }
                        } 
                    }
                }
            });
        }
    </script>
</body>
</html>

